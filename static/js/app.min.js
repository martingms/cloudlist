$(function(){function newTrackHandler(url,model){var host=url.getHostname();switch(host){case "soundcloud.com":return new SoundcloudTrackHandler(url,model);break;case "youtube.com","www.youtube.com":return new YouTubeTrackHandler(url,model);break;default:console.log("This source ("+url+") is not yet supported.")}}function SoundcloudTrackHandler(url,model){var that=this;var apiurl="http://api.soundcloud.com/resolve?url="+url+"&format=json&consumer_key="+settings.sc_consumer_key+"&callback=?";$.getJSON(apiurl,
function(data){that.type="sc";that.title=data.title;that.artworkurl=data.artwork_url;that.downloadurl=data.download_url;that.user={username:data.user.username,userurl:data.user.permalink_url};that.duration=function(){var minutes=data.duration/1E3/60;var floormin=Math.floor(minutes);var seconds=Math.floor((minutes-floormin)*60);if(seconds<=10)seconds=seconds+"0";return floormin+":"+seconds}();that.shorttitle=function(){if(data.title.length>50)return data.title.slice(0,47)+"...";else return data.title}();
that.sound=soundManager.createSound({id:"track_"+that.id,url:function(){var url=data.stream_url;url=url.indexOf("secret_token")==-1?url+"?":url+"&";return url+"consumer_key="+settings.sc_consumer_key}(),onfinish:function(){that.collection.trigger("trackFinished",that)}});that.progress=function(){return(that.sound.position||0)/(that.sound.duration||that.sound.durationEstimate)};model.change(that)});that.playpause=function(){that.sound.togglePause()};that.play=function(){that.sound.play()};that.restartTrack=
function(){soundManager.stopAll();that.sound.play()}}function YouTubeTrackHandler(url,model){var that=this;that.ytid=model.get("url").getYtVideoId();var apiurl="https://gdata.youtube.com/feeds/api/videos/"+that.ytid+"?alt=json";$.ajax({url:apiurl,dataType:"jsonp",beforeSend:function(jqXHR){jqXHR.setRequestHeader("GData-Version",2);jqXHR.setRequestHeader("X-GData-Key","key="+settings.yt_developer_key)},success:function(ytdata){that.type="yt";that.title=ytdata.entry.title.$t;that.artworkurl=ytdata.entry.media$group.media$thumbnail[0].url;
that.user={username:ytdata.entry.author[0].name.$t,userurl:ytdata.entry.author[0].uri.$t};that.duration=function(){var totalSeconds=ytdata.entry.media$group.yt$duration.seconds;var minutes=Math.floor(totalSeconds/60);var seconds=Math.floor((totalSeconds/60-minutes)*60);if(seconds<=10)seconds="0"+seconds;return minutes+":"+seconds}();that.shorttitle=ytdata.entry.title.$t;model.change(that)}});that.progress=function(){if(ytplayerready)return ytplayer.getCurrentTime()/ytplayer.getDuration();else return 0};
that.playpause=function(){switch(ytplayer.getPlayerState()){case -1:ytplayer.loadVideoById(model.get("ytid"));break;case 2:ytplayer.playVideo();break;default:ytplayer.pauseVideo()}};that.play=function(){ytplayer.loadVideoById(that.ytid)};that.restartTrack=function(){ytplayer.seekTo(0)}}var Track=Backbone.Model.extend({initialize:function(){var host=this.get("url").getHostname();this.nonpersistant={};this.nonpersistant.handler=newTrackHandler(this.get("url"),this)},playpause:function(){this.nonpersistant.handler.playpause()},
play:function(){soundManager.stopAll();ytplayer.stopVideo();this.nonpersistant.handler.play()},restartTrack:function(){this.nonpersistant.handler.play()}});var Playlist=Backbone.RelationalModel.extend({relations:[{type:Backbone.HasMany,key:"tracks",relatedModel:"Track"}]});var PlaylistList=Backbone.Collection.extend({model:Playlist,url:"/ajax/playlists"});var TrackList=Backbone.Collection.extend({model:Track,url:"/ajax/tracks"});var TrackView=Backbone.View.extend({tagName:"li",className:"track",template:$("#track-template").html(),
events:{"dblclick":"gotoTrack"},initialize:function(){_.bindAll(this,"render","togglePlaying","gotoTrack");this.model.bind("change",this.render);this.model.view=this;this.render()},render:function(){var html=Mustache.to_html(this.template,_.clone(this.model.nonpersistant));console.log(this.model);$(this.el).html(html);return this},togglePlaying:function(){$(this.el).toggleClass("playing");return this},removePlaying:function(){$(this.el).removeClass("playing");return this},gotoTrack:function(){this.model.collection.trigger("gotoTrack",
this.model)}});var PlayerView=Backbone.View.extend({el:$("#player"),template:$("#player-template").html(),events:{"click #play":"playpause","click #pause":"playpause","click #next":"skipToNextTrack","click #previous":"restartTrack","dblclick #previous":"skipToPrevTrack"},initialize:function(){_.bindAll(this,"render","playpause","skipToNextTrack","gotoTrack","onYtPlayerStateChange","onTrackFinished");if(this.collection.length>0){var that=this;globalEvents.bind("ytPlayerStateChange",this.onYtPlayerStateChange);
this.collection.bind("trackFinished",this.onTrackFinished);this.collection.bind("gotoTrack",this.gotoTrack);this.nextTrack=this.collection.first();this.nextTrack.bind("change",this.render)}},render:function(){var html=Mustache.to_html(this.template,_.clone(this.nextTrack.nonpersistant));this.el.html(html);that=this;setInterval(function(){$("#elapsed").css("width",100*that.nextTrack.nonpersistant.handler.progress()+"%")},500);return this},playpause:function(){this.nextTrack.playpause();$("#play, #pause").toggle();
this.nextTrack.view.togglePlaying()},skipToNextTrack:function(){this.nextTrack.view.removePlaying();if(this.nextTrack==this.collection.last())this.nextTrack=this.collection.first();else this.nextTrack=this.collection.at(this.collection.indexOf(this.nextTrack)+1);this.nextTrack.play();this.nextTrack.view.togglePlaying();this.render();$("#play, #pause").toggle()},skipToPrevTrack:function(){this.nextTrack.view.removePlaying();if(this.nextTrack==this.collection.first())this.nextTrack=this.collection.last();
else this.nextTrack=this.collection.at(this.collection.indexOf(this.nextTrack)-1);this.nextTrack.play();this.nextTrack.view.togglePlaying();this.render();$("#play, #pause").toggle()},restartTrack:function(){this.nextTrack.restartTrack()},gotoTrack:function(track){this.nextTrack.view.removePlaying();this.nextTrack=track;this.nextTrack.play();this.nextTrack.view.togglePlaying();this.render();$("#play, #pause").toggle()},onYtPlayerStateChange:function(state){switch(state){case 0:this.onTrackFinished(this.nextTrack)}},
onTrackFinished:function(track){track.view.removePlaying();if(this.nextTrack==this.collection.last())this.nextTrack=this.collection.first();else this.nextTrack=this.collection.at(this.collection.indexOf(track)+1);this.nextTrack.play();this.nextTrack.view.togglePlaying();this.render();$("#play, #pause").toggle()}});var TracklistView=Backbone.View.extend({el:$("#tracklist"),events:{"click #add":"showInput","keypress #add-track-input":"addTrackOnEnter"},initialize:function(){_.bindAll(this,"render",
"addTrackOnEnter","showInput");this.input=this.$("#add-track-input");this.collection=new TrackList;this.collection.bind("add",this.appendTrack);var that=this;this.collection.fetch({success:function(model,response){for(var track in that.collection.models)that.appendTrack(that.collection.models[track]);this.playerview=new PlayerView({collection:that.collection})},error:function(model,response){new Error("Something went wrong! This was the response: "+response)}})},render:function(){return this},appendTrack:function(track){var view=
new TrackView({model:track});$("ol.tracks").append(view.render().el)},addTrackOnEnter:function(e){if(e.keyCode!=13)return;var model=this.collection.create({url:this.input.val()});if(this.collection.length==1&&this.playerview)this.playerview.initialize();this.input.val("").fadeOut()},showInput:function(){this.input.fadeToggle()}});soundManager.onready(function(){var Tracklist=new TracklistView})});var globalEvents={};_.extend(globalEvents,Backbone.Events);
function ytPlayerStateChange(newState){globalEvents.trigger("ytPlayerStateChange",newState)}window.ytplayerready=false;function onYouTubePlayerReady(){ytplayer.addEventListener("onStateChange","ytPlayerStateChange");window.ytplayerready=true}var settings={sc_consumer_key:"768e41058531333626dd3e913010661a",yt_developer_key:"AI39si6wOs6S58ih1SeRvHNLVtkzXVSO0xHIjy7Au3kuzXEr3yqYUVduuKfxvErG7VJkcL_Q9X1FIhcj42cfVbW6EwDLBIVrBA"};soundManager.url="/static/swf/";soundManager.flashVersion=9;
soundManager.useFlashBlock=false;soundManager.useHighPerformance=true;soundManager.wmode="transparent";soundManager.useFastPolling=true;String.prototype.getHostname=function(){var re=new RegExp("^(?:f|ht)tp(?:s)?://([^/]+)","im");return this.match(re)[1].toString()};String.prototype.getYtVideoId=function(){var video_id=this.split("v=")[1];var ampersandPosition=video_id.indexOf("&");if(ampersandPosition!=-1)return video_id.substring(0,ampersandPosition);else return video_id};
