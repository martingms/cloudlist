$(function(){var Track=Backbone.Model.extend({initialize:function(){var host=this.get("url").getHostname();switch(host){case "soundcloud.com":this.getScTrackInfo();break;case "youtube.com","www.youtube.com":this.set({ytid:this.get("url").getYtVideoId()});this.getYtTrackInfo();break}},getScTrackInfo:function(){var that=this;var apiurl="http://api.soundcloud.com/resolve?url="+this.get("url")+"&format=json&consumer_key="+settings.sc_consumer_key+"&callback=?";$.getJSON(apiurl,function(scdata){that.set({type:"sc",
title:scdata.title,artworkurl:scdata.artwork_url,downloadurl:scdata.download_url,user:{username:scdata.user.username,userurl:scdata.user.permalink_url},duration:function(){var minutes=scdata.duration/1E3/60;var floormin=Math.floor(minutes);var seconds=Math.floor((minutes-floormin)*60);if(seconds<=10)seconds=seconds+"0";return floormin+":"+seconds}(),shorttitle:function(){if(scdata.title.length>50)return scdata.title.slice(0,47)+"...";else return scdata.title}(),sound:soundManager.createSound({id:"track_"+
that.id,url:function(){var url=scdata.stream_url;url=url.indexOf("secret_token")==-1?url+"?":url+"&";return url+"consumer_key="+settings.sc_consumer_key}(),onfinish:function(){that.collection.trigger("trackFinished",that)}})})})},getYtTrackInfo:function(){var that=this;var apiurl="https://gdata.youtube.com/feeds/api/videos/"+this.get("ytid")+"?alt=json";$.ajax({url:apiurl,dataType:"jsonp",beforeSend:function(jqXHR){jqXHR.setRequestHeader("GData-Version",2);jqXHR.setRequestHeader("X-GData-Key","key="+
settings.yt_developer_key)},success:function(ytdata){that.set({type:"yt",title:ytdata.entry.title.$t,artworkurl:ytdata.entry.media$group.media$thumbnail[0].url,user:{username:ytdata.entry.author[0].name.$t,userurl:ytdata.entry.author[0].uri.$t},duration:function(){var totalSeconds=ytdata.entry.media$group.yt$duration.seconds;var minutes=Math.floor(totalSeconds/60);var seconds=Math.floor((totalSeconds/60-minutes)*60);if(seconds<=10)seconds="0"+seconds;return minutes+":"+seconds},shorttitle:ytdata.entry.title.$t})}})},
playpause:function(){switch(this.get("type")){case "sc":this.get("sound").togglePause();break;case "yt":switch(ytplayer.getPlayerState()){case -1:ytplayer.loadVideoById(this.get("ytid"));break;case 2:ytplayer.playVideo();break;default:ytplayer.pauseVideo()}break}},play:function(){soundManager.stopAll();ytplayer.stopVideo();switch(this.get("type")){case "sc":this.get("sound").play();break;case "yt":ytplayer.loadVideoById(this.get("ytid"));break}},restartTrack:function(){soundManager.stopAll();switch(this.get("type")){case "sc":this.get("sound").play();
break;case "yt":ytplayer.seekTo(0);break}}});var Playlist=Backbone.RelationalModel.extend({relations:[{type:Backbone.HasMany,key:"tracks",relatedModel:"Track"}]});var PlaylistList=Backbone.Collection.extend({model:Playlist,url:"/ajax/playlists"});var TrackList=Backbone.Collection.extend({model:Track,url:"/ajax/tracks"});var TrackView=Backbone.View.extend({tagName:"li",className:"track",template:$("#track-template").html(),events:{"dblclick":"gotoTrack"},initialize:function(){_.bindAll(this,"render",
"togglePlaying","gotoTrack");this.model.bind("change",this.render);this.model.view=this;this.render()},render:function(){var html=Mustache.to_html(this.template,this.model.toJSON());$(this.el).html(html);return this},togglePlaying:function(){$(this.el).toggleClass("playing");return this},removePlaying:function(){$(this.el).removeClass("playing");return this},gotoTrack:function(){this.model.collection.trigger("gotoTrack",this.model)}});var PlayerView=Backbone.View.extend({el:$("#player"),template:$("#player-template").html(),
events:{"click #play":"playpause","click #pause":"playpause","click #next":"skipToNextTrack","click #previous":"restartTrack","dblclick #previous":"skipToPrevTrack"},initialize:function(){_.bindAll(this,"render","playpause","skipToNextTrack","gotoTrack","onYtPlayerStateChange","onTrackFinished","startProgressBar");if(this.collection.length>0){var that=this;globalEvents.bind("ytPlayerStateChange",this.onYtPlayerStateChange);this.collection.bind("trackFinished",this.onTrackFinished);this.collection.bind("gotoTrack",
this.gotoTrack);this.nextTrack=this.collection.first();this.nextTrack.bind("change",this.render)}},render:function(){var html=Mustache.to_html(this.template,this.nextTrack.toJSON());this.el.html(html);return this},playpause:function(){this.nextTrack.playpause();clearInterval(this.nextTrack.interval);this.nextTrack.interval=null;$("#play, #pause").toggle();this.startProgressBar();this.nextTrack.view.togglePlaying()},skipToNextTrack:function(){this.nextTrack.view.removePlaying();clearInterval(this.nextTrack.interval);
this.nextTrack.interval=null;if(this.nextTrack==this.collection.last())this.nextTrack=this.collection.first();else this.nextTrack=this.collection.at(this.collection.indexOf(this.nextTrack)+1);this.startProgressBar();this.nextTrack.play();this.nextTrack.view.togglePlaying();this.render();$("#play, #pause").toggle()},skipToPrevTrack:function(){this.nextTrack.view.removePlaying();clearInterval(this.nextTrack.interval);this.nextTrack.interval=null;if(this.nextTrack==this.collection.first())this.nextTrack=
this.collection.last();else this.nextTrack=this.collection.at(this.collection.indexOf(this.nextTrack)-1);this.startProgressBar();this.nextTrack.play();this.nextTrack.view.togglePlaying();this.render();$("#play, #pause").toggle()},restartTrack:function(){this.nextTrack.restartTrack()},gotoTrack:function(track){this.nextTrack.view.removePlaying();clearInterval(this.nextTrack.interval);this.nextTrack.interval=null;this.nextTrack=track;this.startProgressBar();this.nextTrack.play();this.nextTrack.view.togglePlaying();
this.render();$("#play, #pause").toggle()},onYtPlayerStateChange:function(state){switch(state){case 0:this.onTrackFinished(this.nextTrack)}},onTrackFinished:function(track){track.view.removePlaying();clearInterval(this.nextTrack.interval);this.nextTrack.interval=null;if(this.nextTrack==this.collection.last())this.nextTrack=this.collection.first();else this.nextTrack=this.collection.at(this.collection.indexOf(track)+1);this.startProgressBar();this.nextTrack.play();this.nextTrack.view.togglePlaying();
this.render();$("#play, #pause").toggle()},startProgressBar:function(){var that=this;switch(this.nextTrack.get("type")){case "sc":var sound=this.nextTrack.get("sound");var duration,progress;this.nextTrack.interval=setInterval(function(){duration=sound.duration||sound.durationEstimate;progress=sound.position/duration;$("#elapsed").css("width",100*progress+"%");console.log("Duration: "+duration);console.log("Progress (%): "+100*progress);console.log("Position: "+sound.position)},500);case "yt":var duration,
progress;var timecounter=0;this.nextTrack.interval=setInterval(function(){timecounter+=0.5;duration=ytplayer.getDuration();progress=timecounter/duration;$("#elapsed").css("width",100*progress+"%")},500)}}});var TracklistView=Backbone.View.extend({el:$("#tracklist"),events:{"click #add":"showInput","keypress #add-track-input":"addTrackOnEnter"},initialize:function(){_.bindAll(this,"render","addTrackOnEnter","showInput");this.input=this.$("#add-track-input");this.collection=new TrackList;this.collection.bind("add",
this.appendTrack);var that=this;this.collection.fetch({success:function(model,response){for(var track in that.collection.models)that.appendTrack(that.collection.models[track]);this.playerview=new PlayerView({collection:that.collection})},error:function(model,response){new Error("Something went wrong! This was the response: "+response)}})},render:function(){return this},appendTrack:function(track){var view=new TrackView({model:track});$("ol.tracks").append(view.render().el)},addTrackOnEnter:function(e){if(e.keyCode!=
13)return;var model=this.collection.create({url:this.input.val()});if(this.collection.length==1&&this.playerview)this.playerview.initialize();this.input.val("").fadeOut()},showInput:function(){this.input.fadeToggle()}});soundManager.onready(function(){var Tracklist=new TracklistView})});var globalEvents={};_.extend(globalEvents,Backbone.Events);function ytPlayerStateChange(newState){globalEvents.trigger("ytPlayerStateChange",newState)}
function onYouTubePlayerReady(){ytplayer.addEventListener("onStateChange","ytPlayerStateChange")}var settings={sc_consumer_key:"768e41058531333626dd3e913010661a",yt_developer_key:"AI39si6wOs6S58ih1SeRvHNLVtkzXVSO0xHIjy7Au3kuzXEr3yqYUVduuKfxvErG7VJkcL_Q9X1FIhcj42cfVbW6EwDLBIVrBA"};soundManager.url="/static/swf/";soundManager.flashVersion=9;soundManager.useFlashBlock=false;soundManager.useHighPerformance=true;soundManager.wmode="transparent";soundManager.useFastPolling=true;
String.prototype.getHostname=function(){var re=new RegExp("^(?:f|ht)tp(?:s)?://([^/]+)","im");return this.match(re)[1].toString()};String.prototype.getYtVideoId=function(){var video_id=this.split("v=")[1];var ampersandPosition=video_id.indexOf("&");if(ampersandPosition!=-1)return video_id.substring(0,ampersandPosition);else return video_id};
